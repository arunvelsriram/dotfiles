#!/bin/bash

source brew.sh

DIRS_AND_FILES=(bashrc bash_profile profile zshrc gitconfig gemrc vimrc gvimrc tool-versions oh-my-zsh/custom/aliases.zsh oh-my-zsh/custom/tw_digital.zsh)
BACKUP_DIR=~/dotfiles.backup_existing_dotfiles.`date +%-H-%M-%S-%F`

create_directories() {
  mkdir -p $BACKUP_DIR
  mkdir -p $BACKUP_DIR/oh-my-zsh/custom
}

backup_existing_dotfiles() {
  for dir_or_file in ${DIRS_AND_FILES[@]}; do
    full_path=~/.$dir_or_file
    if [[ -f $full_path ]]; then
      cp $full_path $BACKUP_DIR/$dir_or_file
    elif [[ -d $full_path ]]; then
      mkdir -p $full_path
      cp -R $full_path/ $BACKUP_DIR/$dir_or_file
    fi
  done

  echo Copied existing files to $BACKUP_DIR
  echo
}

setup_dotfiles() {
  for dir_or_file in ${DIRS_AND_FILES[@]}; do
    full_path=~/.$dir_or_file
    [ -f $full_path ] && rm $full_path
    [ -d $full_path ] && rm -rf $full_path
    ln -sv ~/dotfiles/$dir_or_file $full_path
  done
}

vim_plugins() {
  [ -d ~/.vim/bundle/Vundle.vim ] || git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim
  vim +PluginInstall +qall
}

install_powerline_fonts() {
  git clone https://github.com/powerline/fonts.git --depth=1
  cd fonts
  ./install.sh
  cd ..
  rm -rf fonts
}

iterm_preferences() {
  defaults write com.googlecode.iterm2.plist LoadPrefsFromCustomFolder -bool true
  defaults write com.googlecode.iterm2.plist PrefsCustomFolder -string "~/dotfiles/iterm"
  defaults write com.googlecode.iterm2.plist NSNavLastRootDirectory -string "/iterm"
  defaults write com.googlecode.iterm2.plist NoSyncNeverRemindPrefsChangesLostForFile_selection -int 0
}

spectacle_shortcuts() {
  rm ~/Library/Application\ Support/Spectacle/Shortcuts.json
  ln -sv ~/dotfiles/spectacle/Shortcuts.json ~/Library/Application\ Support/Spectacle/Shortcuts.json
}

install_rvm() {
  curl -sSL https://get.rvm.io | bash -s -- --ignore-dotfiles stable
}

install_brew
brew_packages

create_directories
backup_existing_dotfiles
setup_dotfiles

vim_plugins

# font installation should happen before iterm prefs
install_powerline_fonts
iterm_preferences

spectacle_shortcuts

# rvm is not available through brew
install_rvm

echo
echo "Done. Restart iTerm to see the changes."
